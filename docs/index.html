<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Beacon Run</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="network.js"></script>
  <script src="contract.js"></script>
</head>
<body>

  <!-- –õ–æ–≥–æ —Å–ª–µ–≤–∞ (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ) -->
  <div class="logo" onclick="window.open('https://testnet.pharosnetwork.xyz/', '_blank')">
    <img src="img/pharos-logo.png" alt="Pharos Logo">
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É -->
  <div class="top-buttons">
    <button id="connectBtn">üîó Connect Wallet</button>
    <button id="leaderBtn">üèÜ Leaderboard</button>
    <button id="musicBtn">üéµ Music On</button>
  </div>

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="title">
    <h1>Play Beacon Run</h1>
    <h2>Win Tokens</h2>
  </div>

  <!-- –í–∏–¥–µ–æ-—Ä–∞–º–∫–∞ -->
  <div class="video-frame">
    <video id="introVideo" autoplay loop muted playsinline>
      <source src="video/intro.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <!-- Start + —Å–æ—Ü—Å–µ—Ç–∏ -->
  <div class="start-container">
    <button id="startBtn" disabled>‚ñ∂ Start Game</button>
    <div id="walletStatus" style="margin-top:10px; color:#0ff; font-size:14px;"></div>
    <div class="socials">
      <a href="https://twitter.com/pharos_network" target="_blank" class="social-btn">
        <img src="img/twitter.png" alt="Twitter" class="twitter-icon"> PHAROS_NETWORK
      </a>
      <a href="https://twitter.com/maysonkiller23" target="_blank" class="social-btn">
        <img src="img/twitter.png" alt="Twitter" class="twitter-icon"> Developer
      </a>
    </div>
  </div>

  <!-- –ú—É–∑—ã–∫–∞ -->
  <audio id="bgMusic" src="music/music.mp3" loop></audio>

  <script>
const bgMusic = document.getElementById("bgMusic");
const musicBtn = document.getElementById("musicBtn");
const connectBtn = document.getElementById("connectBtn");
const startBtn = document.getElementById("startBtn");
const leaderBtn = document.getElementById("leaderBtn");
const walletStatus = document.getElementById("walletStatus");

let provider, signer, contract, userAddress;

// ===== Modal for nickname =====
function nicknameModal(onSubmit) {
  const wrap = document.createElement("div");
  Object.assign(wrap.style, { 
    position: "fixed", inset: "0", display: "grid", placeItems: "center", 
    background: "rgba(0,0,0,.6)", zIndex: "9999"
  });

  wrap.innerHTML = `
    <div style="
      min-width: 320px;
      max-width: 90vw;
      background: rgba(10,12,25,.95);
      border: 2px solid #0ff;
      border-radius: 16px;
      padding: 18px;
      color: #0ff;
      font-family: 'Space Grotesk', sans-serif;
      box-shadow: 0 10px 40px rgba(0,255,255,.25);
      box-sizing: border-box;
      text-align: center;
    ">
      <h2>Enter Nickname</h2>
      <input id="nickInput" type="text" placeholder="3-32 characters"
        style="
          width: 100%;
          max-width: 100%;
          padding: 10px;
          border: 2px solid #0ff;
          background: #000;
          color: #0ff;
          border-radius: 8px;
          margin-bottom: 10px;
          box-sizing: border-box;
        ">
      <button id="submitNick" style="
          padding: 10px 20px;
          border: 2px solid #0ff;
          background: #000;
          color: #0ff;
          border-radius: 8px;
          cursor: pointer;
          box-sizing: border-box;
        ">Submit</button>
    </div>
  `;

  document.body.appendChild(wrap);

  const input = wrap.querySelector("#nickInput");
  const btn = wrap.querySelector("#submitNick");

  btn.onclick = () => {
    const nick = input.value.trim();
    if (nick.length >= 3 && nick.length <= 32) {
      onSubmit(nick);
      wrap.remove();
    } else {
      alert("Invalid nickname.");
    }
  };
  return { el: wrap };
}

// ===== –ú—É–∑—ã–∫–∞ =====
musicBtn.addEventListener("click", () => {
  if (bgMusic.paused) {
    bgMusic.play().catch(()=>{});
    musicBtn.textContent = "üéµ Music On";
  } else {
    bgMusic.pause();
    musicBtn.textContent = "üéµ Music Off";
  }
});

// ===== –õ–∏–¥–µ—Ä–±–æ—Ä–¥ =====
leaderBtn.addEventListener("click", () => {
  window.location.href = "leaderboard.html";
});

// ===== –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ + —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è =====
async function connect() {
  if (!window.ethereum) { alert("Install an EVM-compatible wallet like MetaMask!"); return; }
  await window.ensurePharos();

  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  contract = new ethers.Contract(window.BeaconRun_ADDRESS, window.BeaconRun_ABI, signer);

  try {
    const p = await contract.players(userAddress);
    if (!p.registered) {
      nicknameModal(async (nickname) => {
        try {
          const tx = await contract.registerPlayer(nickname, { gasLimit: 300000 });
          await tx.wait();
          alert(`Registered: ${nickname}`);
          walletStatus.textContent = `Connected: ${shortAddress(userAddress)} | Name: ${nickname}`;
          startBtn.disabled = false;
        } catch (regError) {
          console.error(regError);
          if (regError.message.includes("already registered") || 
              (regError.data && regError.data.message.includes("already registered"))) {
            alert("You are already registered. Welcome back!");
          } else {
            alert("Registration failed.");
          }
        }
      });
    } else {
      alert(`Welcome back, ${p.nickname}!`);
      walletStatus.textContent = `Connected: ${shortAddress(userAddress)} | Name: ${p.nickname}`;
      startBtn.disabled = false;
    }
  } catch (e) {
    console.error(e);
    alert("Failed to connect/verify player.");
  }
}

function shortAddress(addr) {
  return addr.slice(0,6) + "..." + addr.slice(-4);
}

connectBtn.addEventListener("click", connect);

// ===== –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∏–≥—Ä—É =====
startBtn.addEventListener("click", async () => {
  if (!signer) { 
    alert("Connect wallet first!"); 
    return; 
  }
  window.location.href = "game.html";
});
  </script>
</body>
</html>
